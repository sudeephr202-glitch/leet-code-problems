import java.util.*;

class Solution {

    // Map to store transitions: "AB" -> list of possible top blocks
    private Map<String, List<Character>> map = new HashMap<>();

    public boolean pyramidTransition(String bottom, List<String> allowed) {
        // Build transition map
        for (String s : allowed) {
            String key = s.substring(0, 2);
            char value = s.charAt(2);
            map.computeIfAbsent(key, k -> new ArrayList<>()).add(value);
        }
        return dfs(bottom);
    }

    private boolean dfs(String row) {
        // If only one block remains, pyramid is complete
        if (row.length() == 1) return true;

        // Generate all possible rows above
        return buildNextRow(row, 0, new StringBuilder());
    }

    private boolean buildNextRow(String row, int index, StringBuilder next) {
        // If next row is fully built, recurse
        if (index == row.length() - 1) {
            return dfs(next.toString());
        }

        String key = row.substring(index, index + 2);

        // If no valid transition exists
        if (!map.containsKey(key)) return false;

        // Try all possible top blocks
        for (char c : map.get(key)) {
            next.append(c);
            if (buildNextRow(row, index + 1, next)) {
                return true;
            }
            next.deleteCharAt(next.length() - 1); // backtrack
        }

        return false;
    }
}
