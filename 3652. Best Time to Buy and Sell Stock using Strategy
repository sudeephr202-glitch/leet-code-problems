class Solution {
    public long maxProfit(int[] prices, int[] strategy, int k) {
        int n = prices.length;

        // 1. Base profit
        long base = 0;
        for (int i = 0; i < n; i++) {
            base += (long) strategy[i] * prices[i];
        }

        // 2. Prefix sums
        long[] prefSP = new long[n + 1]; // strategy[i] * prices[i]
        long[] prefP  = new long[n + 1]; // prices[i]

        for (int i = 0; i < n; i++) {
            prefSP[i + 1] = prefSP[i] + (long) strategy[i] * prices[i];
            prefP[i + 1]  = prefP[i] + prices[i];
        }

        // 3. Sliding window to find best gain
        long bestGain = 0;
        int half = k / 2;

        for (int l = 0; l + k <= n; l++) {
            int mid = l + half;
            int r = l + k;

            long oldFirst  = prefSP[mid] - prefSP[l];
            long oldSecond = prefSP[r] - prefSP[mid];
            long newSecond = prefP[r] - prefP[mid];

            long gain = -oldFirst + (newSecond - oldSecond);
            bestGain = Math.max(bestGain, gain);
        }

        // 4. Final answer
        return base + bestGain;
    }
}
